name: Deploy to Azure

on:
  push:
    branches:
      - main

permissions:
  id-token: write
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Log in to Azure using Federated Identity Credentials
      uses: azure/login@v1.5
      with:
        client-id: ${{ secrets.AZURE_CLIENT_ID }}
        tenant-id: ${{ secrets.AZURE_TENANT_ID }}
        subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

    - name: Create Resource Group
      run: |
        az group create --name crc-static-site-rg --location eastus

    - name: Deploy Bicep Template
      run: |
        az deployment group create \
          --resource-group crc-static-site-rg \
          --template-file infra/storage.bicep

    - name: Upload files to $web container using Azure AD
      run: |
        STORAGE_ACCOUNT_NAME=$(az deployment group show --name crc-static-site-rg --resource-group crc-static-site-rg --query properties.outputs.storageAccountName.value -o tsv)
        az storage blob upload-batch \
          --account-name $STORAGE_ACCOUNT_NAME \
          --container-name '$web' \
          --source src

    - name: Enable Static Website
      run: |
        STORAGE_ACCOUNT_NAME=$(az deployment group show --name crc-static-site-rg --resource-group crc-static-site-rg --query properties.outputs.storageAccountName.value -o tsv)
        az storage blob service-properties update \
          --account-name $STORAGE_ACCOUNT_NAME \
          --static-website \
          --index-document index.html \
          --404-document error.html

    - name: Output Static Website URL
      run: |
        STORAGE_ACCOUNT_NAME=$(az deployment group show --name crc-static-site-rg --resource-group crc-static-site-rg --query properties.outputs.storageAccountName.value -o tsv)
        STATIC_SITE_URL=$(az storage account show --name $STORAGE_ACCOUNT_NAME --resource-group crc-static-site-rg --query 'primaryEndpoints.web' --output tsv)
        echo "Static site URL: $STATIC_SITE_URL"
